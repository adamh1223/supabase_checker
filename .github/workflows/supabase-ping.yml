- name: Write .env from GitHub secret
  shell: bash
  run: |
    # Fail fast if the secret is missing/empty
    if [ -z "${SUPABASE_ENV}" ]; then
      echo "SUPABASE_ENV secret is empty or not set"
      exit 1
    fi

    # Write it to .env (preserves newlines)
    cat > .env << 'EOF'
${SUPABASE_ENV}
EOF

    # Show which variables are present (names only; no secrets)
    echo "Variables detected in .env:"
    grep -E '^(SUPABASE_URL|SUPABASE_KEY|SUPABASE_TARGET_URL|SUPABASE_ENDPOINT_PATH|SUPABASE_ANON_KEY)_' .env | sed 's/=.*$/=*** (redacted)/' || true
    grep -E '^(SUPABASE_URL|SUPABASE_KEY|SUPABASE_TARGET_URL|SUPABASE_ENDPOINT_PATH|SUPABASE_ANON_KEY)=' .env | sed 's/=.*$/=*** (redacted)/' || true
  env:
    SUPABASE_ENV: ${{ secrets.SUPABASE_ENV }}
